- name: Validate required variables
  ansible.builtin.assert:
    that:
      - arch_install_disk is defined
      - arch_install_disk | length > 0
      - arch_install_swap_size is defined
      - arch_install_swap_size | length > 0
    fail_msg: "arch_install_disk and arch_install_swap_size must be defined (e.g., disk: '/dev/sda', swap: '8GiB')"
  tags:
    - never
    - arch-install

- name: Wipe all partitions from disk
  ansible.builtin.command:
    cmd: "sgdisk --zap-all {{ arch_install_disk }}"
  changed_when: true
  tags:
    - never
    - arch-install

- name: Create swap partition
  community.general.parted:
    device: "{{ arch_install_disk }}"
    number: 1
    state: present
    part_start: 1MiB
    part_end: "{{ arch_install_swap_size }}"
    fs_type: linux-swap
  tags:
    - never
    - arch-install

- name: Create Linux root partition
  community.general.parted:
    device: "{{ arch_install_disk }}"
    number: 2
    state: present
    part_start: "{{ arch_install_swap_size }}"
    part_end: 100%
    fs_type: ext4
  tags:
    - never
    - arch-install

- name: Format swap partition
  community.general.filesystem:
    device: "{{ arch_install_disk }}1"
    fstype: swap
  tags:
    - never
    - arch-install
    - arch-install-format

- name: Format root partition
  community.general.filesystem:
    device: "{{ arch_install_disk }}2"
    fstype: ext4
  tags:
    - never
    - arch-install
    - arch-install-format

- name: Mount root filesystem
  ansible.posix.mount:
    path: /mnt
    src: "{{ arch_install_disk }}2"
    fstype: ext4
    state: present
  tags:
    - never
    - arch-install
    - arch-install-mount

- name: Turn on swap
  ansible.builtin.command: "swapon {{ arch_install_disk }}1"
  changed_when: true
  tags:
    - never
    - arch-install
    - arch-install-mount
