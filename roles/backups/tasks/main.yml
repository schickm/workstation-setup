---
- name: Validate required backup variables
  ansible.builtin.assert:
    that:
      - backups_application_key_id is defined
      - backups_application_key_id | length > 0
      - backups_application_key is defined
      - backups_application_key | length > 0
      - backups_directories is defined
      - backups_directories is iterable
      - backups_directories | length > 0
    fail_msg: "backups_application_key_id, backups_application_key, and backups_directories must be defined in inventory"
    success_msg: "Required backup variables are defined"

- name: Install AUR packages
  kewlfft.aur.aur:
    name:
      - backblaze-b2-bin
  when: ansible_facts['os_family'] == 'Archlinux'

- name: Get existing buckets
  command: "bbb2 bucket get {{ item.bucket }}"
  loop: "{{ backups_directories }}"
  register: bucket_check
  changed_when: false
  failed_when: false
  tags: bucket-create

- name: Create missing B2 buckets
  command: bbb2 bucket create {{ item.item.bucket }} allPrivate
  environment:
    B2_APPLICATION_KEY_ID: "{{ backups_application_key_id }}"
    B2_APPLICATION_KEY: "{{ backups_application_key }}"
  loop: "{{ bucket_check.results }}"
  when: item.rc != 0
  tags: bucket-create

- name: Deploy credentials file
  ansible.builtin.template:
    src: backblaze-backup.env.j2
    dest: /etc/backblaze-backup.env
    owner: root
    group: root
    mode: '0600'
  become: true

- name: Deploy backup script
  ansible.builtin.template:
    src: backblaze-backup.sh.j2
    dest: /usr/local/bin/backblaze-backup.sh
    owner: root
    group: root
    mode: '0700'
  become: true

- name: Deploy systemd service unit
  ansible.builtin.template:
    src: backblaze-backup.service.j2
    dest: /etc/systemd/system/backblaze-backup.service
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Deploy systemd timer unit
  ansible.builtin.template:
    src: backblaze-backup.timer.j2
    dest: /etc/systemd/system/backblaze-backup.timer
    owner: root
    group: root
    mode: '0644'
  become: true

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true

- name: Enable and start backup timer
  ansible.builtin.systemd:
    name: backblaze-backup.timer
    enabled: true
    state: started
  become: true
